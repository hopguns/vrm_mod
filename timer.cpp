#include <avr/io.h>
#include <avr/interrupt.h>
#include "timer.h"
#include "ds18b20.h"
#include "vrm.h"
//************************************************************************
// Gestion globale
//************************************************************************
uint8_t countA_Timer0, countB_Timer0;
uint16_t	masterLifeSign;
//************************************************************************
// Initialisation du timer
//************************************************************************
void initTimer()
{
	//--------------------------------------------------------------------
	countA_Timer0 = countB_Timer0 = TIMER0_COUNT_1MS;
	//--------------------------------------------------------------------
	TCCR0B |= ((1 << CS02)); // Prescaler = 256
	//TCCR0B |= ((1 << CS02) | (1 << CS00)); // Prescaler = 1024
	//--------------------------------------------------------------------
	TCNT0 = 0; // initialize counter
	OCR0A = countA_Timer0;
	OCR0B = countB_Timer0;
    TIMSK0 |= ((1 << OCIE0A) | (1 << OCIE0B));
	//--------------------------------------------------------------------
}
//************************************************************************
// Interruption périodique
//************************************************************************
ISR(TIMER0_COMPA_vect)
{
	//--------------------------------------------------------------------
	OCR0A = TCNT0 + countA_Timer0;
	if (masterLifeSign > 0) masterLifeSign--;
	if (timerMsVRM > 0) timerMsVRM--;
	//--------------------------------------------------------------------
}
//************************************************************************
// Interruption périodique
//************************************************************************
ISR(TIMER0_COMPB_vect)
{
	//--------------------------------------------------------------------
	OCR0B = TCNT0 + countB_Timer0;
	if (timerMsDS18B20 > 0) timerMsDS18B20--;
	//--------------------------------------------------------------------
}
//************************************************************************
//
//************************************************************************