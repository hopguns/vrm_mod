#include <string.h>
#include <avr/eeprom.h>
#include <bootFunc.h>
#include "eeparam.h"
#include "HomeBusFunc.h"
//************************************************************************
// Variables globales
//************************************************************************
SParam param;
//------------------------------------------------------------------------
/* SParam EEMEM eeParam =
{
	//--------------------------------------------------------------------
	0x55, //Start toujour = 0x55;
	//--------------------------------------------------------------------
	false,
	false,
	//--------------------------------------------------------------------
	30000, //timeFullUp = 30000;
	30000, //timeFullDown = 30000;
	1000, //timeMaxWaitIvr = 1000;
	2000, //timeShowButee = 2000;
	1000, //timeIvrMargin = 1000;
	10000, //timeForceMargin = 10000;
	//--------------------------------------------------------------------
	5, //nbMesIvrDetect = 5	;
	20, //valIvrCurrentOff = 20;
	50, //valIvrCurrentOn = 50;
	//--------------------------------------------------------------------
	200, //timeBuzzerAlarmOn = 200;
	500, //timeBuzzerAlarmOff = 500;
	200, //timeBuzzerTestOn = 200;
	500, //timeBuzzerTestOff = 500;
	200, //timeBuzzerCmdeOn = 200;
	200, //timeBuzzerCmdeOff = 200;
	4, //timeBuzzerCmdeNum = 4;
	//--------------------------------------------------------------------
	0xAA, //End toujour = 0xAA;
	//--------------------------------------------------------------------
};*/
//------------------------------------------------------------------------
//************************************************************************
// Valeur par défault des paramètres VRM
//************************************************************************
void	initParam()
{
	//--------------------------------------------------------------------
	param.start = 0x55;
	//--------------------------------------------------------------------
	param.version = EE_VERSION;
	//--------------------------------------------------------------------
	param.optionAlarm = false;
	param.optionDS18B20 = false;
	param.tempoDS18B20 = 10;
	//--------------------------------------------------------------------
	param.timeFullUp = 30000;
	param.timeFullDown = 30000;
	param.timeMaxWaitIvr = 1000;
	param.timeStretchUp = 5000;
	param.timeShowButee = 2000;
	param.timeIvrMargin = 1000;
	param.timeForceMargin = 10000;
	//--------------------------------------------------------------------
	param.nbMesIvrDetect = 5;
	param.valIvrCurrentOff = 20;
	param.valIvrCurrentOn = 50;
	//--------------------------------------------------------------------
	param.timeBuzzerAlarmOn = 200;
	param.timeBuzzerAlarmOff = 500;
	param.timeBuzzerTestOn = 200;
	param.timeBuzzerTestOff = 500;
	param.timeBuzzerCmdeOn = 200;
	param.timeBuzzerCmdeOff = 200;
	param.timeBuzzerCmdeNum = 4;
	//--------------------------------------------------------------------
	param.end = 0xAA;
	//--------------------------------------------------------------------
    addEventHomeBus(HOMEBUS_EVENT_VRM_EEPROM_INIT);
	//--------------------------------------------------------------------
}
//************************************************************************
// Lit les paramètres dans l'EEPROM
//************************************************************************
bool	loadParam()
{
	//---------------------------------------------------------------------
	eeprom_read_block(&param, EEPROM_VAR_END, sizeof(param));
	//---------------------------------------------------------------------
	if ((param.start == 0x55) && (param.end == 0xAA) && (param.version == EE_VERSION)) return true;
	initParam();
	return false;
	//---------------------------------------------------------------------
}
//************************************************************************
// enregistre uniquement les modificiations des parametres dans l'EEPROM
//************************************************************************
void  saveParam()
{
	//---------------------------------------------------------------------
	param.start = 0x55;
	param.end = 0xAA;
	//---------------------------------------------------------------------
	eeprom_update_block(&param, EEPROM_VAR_END, sizeof(param));
	//---------------------------------------------------------------------
}
//************************************************************************
// Fin de listing
//************************************************************************
